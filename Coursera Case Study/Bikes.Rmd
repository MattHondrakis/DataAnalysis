---
title: 'Coursera Case Study: Bikes'
author: "Matthew"
date: "2022-11-10"
output: 
  github_document:
    toc: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, dpi = 500)
library(tidyverse)
library(scales)
library(patchwork)
library(tidymodels)
library(lubridate)
theme_set(theme_bw())
theme_update(plot.title = element_text(hjust = 0.5))
theme_update(panel.grid.minor = element_blank())
```

# Google Analytics Case Study: Cyclistic

The purpose of this case study is the dive into the data and find the differences between members and casuals, with the hopes of converting casuals to members. Members are individuals that buy an annual subscription service, while casuals are individuals that buy single ride passes.

Multiple data sets (13) were downloaded from a link provided by [Coursera](https://divvy-tripdata.s3.amazonaws.com/index.html) and then was merged into one csv, which was subsequently read using the code chunk below. The first chunk uses a for-loop to iterate the *read_csv* (read data files) and *rbind* (combine data rowwise) functions till all data files are read; which is then saved as a csv of its own. Now the csv can be read only once using the following code chunk without going through the iteration process.

```{r eval=FALSE}
files <- list.files("D:/Downloads/Case Study")
bikes <- read_csv("D:/Downloads/Case Study/202110-divvy-tripdata.csv")

for(i in 2:length(files)) {
  bikes <- bikes %>% rbind(read_csv(paste0("D:/Downloads/Case Study/",
                   files[i])))
}

write_csv(bikes, "bikes.csv")
```

```{r}
bikes <- read_csv("D:/Downloads/Case Study/Full Data/bikes.csv")
```

Create columns that are the *length* of bike ride (in minutes) and *day_of_week* (1 = Sunday, 7 = Saturday).

```{r}
bikes$length <- difftime(bikes$ended_at, bikes$started_at, unit = "mins")
bikes$day_of_week <- wday(bikes$started_at)
bikes$day_label <- wday(bikes$started_at, label = TRUE)
```

```{r}
s_bikes <- bikes %>% sample_n(500000)  # sample data set only for the purpose of quicker computations during analysis
```

# Data Validation

There are some instances where the data suggests that an individual started a ride after they ended it. This will be assumed to be faulty and the roles will be reversed. The faulty data consists of only **0.00175%** (112 out of 6.3m) of the total data.

```{r}
bikes %>% 
  summarize(neg_time = mean(length < 0) * 100)

bikes %>% 
  filter(length < 0) %>% 
  select(started_at, ended_at)
```

```{r}
bikes$length <- abs(bikes$length)
s_bikes$length <- abs(s_bikes$length)
```

```{r}
skimr::skim_without_charts(bikes %>% select(-matches("lng|lat")))
```

# Exploratory Data Analysis

## Casuals vs Members

**Summary**

-   There are *3.77* million rides by members and *2.61* million rides by casuals, accounting for *59.1%* and *40.9%* of the data, respectively.
-   Members and casuals have approximately equal duration distributions, with casuals having a slightly longer rides.
-   Members tend to use rides during the weekday while casuals tend to use rides during the weekend.
-   Casuals disproportionately prefer specific bike stations.
-   Number of rides peak at both 8:00 am and 5:00 pm for members, while rides for casuals peak only at 5:00 pm.

```{r}
bikes %>% 
  count(member_casual, sort = TRUE) %>% 
  mutate(percent = n/sum(n)*100)
```

### Ride Duration Distributions

```{r}
(bikes %>% 
  ggplot(aes(as.numeric(length), member_casual, fill = member_casual)) + 
  geom_boxplot() +
  scale_x_log10(label = comma_format()) + labs(y = "", x = "", fill = "") + scale_fill_manual(values = c("blue", "green4")))/
(bikes %>% 
   ggplot(aes(as.numeric(length), fill = member_casual)) + 
   geom_density(alpha = 0.5) + theme(legend.position = "none") +
   scale_x_log10(label = comma_format()) + labs(y = "", x = "") + scale_fill_manual(values = c("blue", "green4"))) +
  plot_annotation(title = "Ride Duration Distributions") + plot_layout(guides = "collect")
```

### Weekdays vs Weekends

Members and casuals appear to use rides for different reasons.

-   Members tend to use rides on weekdays, which implies its used to commute to and from work; while casuals tend to use rides on the weekend, which implies that the main purpose of use is leisure.

```{r}
(bikes %>% 
  ggplot(aes(fct_reorder(day_label, day_of_week), fill = member_casual)) + 
  geom_bar(position = position_dodge2()) + 
  scale_fill_manual(values = c("blue", "green4")) +
  scale_y_continuous(labels = comma_format()) +
  labs(y = "", x = "", 
       title = "Days Members and Casuals Use Rides",
       fill = "")) /
bikes %>% 
  mutate(wend = ifelse(day_label %in% c("Sat", "Sun"), "Weekend", "Weekday")) %>% 
  group_by(member_casual) %>% 
  count(wend, sort = TRUE) %>% 
  mutate(percent = n/sum(n)) %>% 
  ggplot(aes(x = member_casual, y = percent, fill = wend)) + 
  geom_bar(position="fill", stat = "identity") +
  geom_text(aes(y = ifelse(percent > 0.50, 0.65, 0.15), label = paste0(round(percent, 3)*100,"%"))) +
  scale_fill_brewer(palette = "Accent", direction = -1) + 
  theme(axis.ticks = element_blank(), axis.text.y = element_blank()) +
  scale_y_continuous(label = percent_format()) +
  labs(y = "", x = "", fill = "", title = "Percentage of Rides Used on Weekdays or Weekends")
```

### Type of Bikes Used

```{r}
bikes %>% 
  group_by(member_casual) %>% 
  count(rideable_type, sort = TRUE) %>% 
  mutate(total = sum(n), pct = n/total) %>% 
  ggplot(aes(pct, member_casual, fill = rideable_type)) + 
  geom_col(position = position_dodge2()) +
  scale_x_continuous(label = percent_format()) + 
  geom_text(aes(label = paste0(round(pct, 3)*100, "%")), position = position_dodge2(0.9), hjust = 1.1) +
  labs(title = "Proportion of Bikes Used by Membership", y = "", x = "", fill = "") +
  scale_fill_brewer(palette = "Set2", direction = -1)
```

### Popular Start Stations

```{r}
(bikes %>% 
  filter(!is.na(start_station_name)) %>% 
  group_by(member_casual) %>% 
  count(start_station_name, sort = TRUE) %>% 
  top_n(5) %>% 
  ggplot(aes(n, fct_reorder(start_station_name, n), fill = member_casual)) + 
  geom_col() +
  geom_text(aes(label = n), color = "white", fontface = "bold", hjust = 1.2) +
  labs(y = "", x = "", fill = "", title = "Start Stations") + theme(plot.title = element_text(hjust = 0)) +
  scale_fill_manual(values = c("blue", "green4"))) /
bikes %>% 
  filter(!is.na(end_station_name)) %>% 
  group_by(member_casual) %>% 
  count(end_station_name, sort = TRUE) %>% 
  top_n(5) %>% 
  ggplot(aes(n, fct_reorder(end_station_name, n), fill = member_casual)) + 
  geom_col() +
  geom_text(aes(label = n), color = "white", fontface = "bold", hjust = 1.2) +
  labs(y = "", x = "", fill = "", title = "End Stations") +
  scale_fill_manual(values = c("blue", "green4")) + theme(plot.title = element_text(hjust = 0)) +
  plot_layout(guides = "collect") + plot_annotation(title = "Top 10 Stations")
```

The number of rides started, locally peak at 8:00 am and 5:00 pm for members, which further reinforces the hypothesis that members use rides to go and come back from work. This assumption is based on the fact that the typical work hours are from 9am-5pm, which would lead people start rides at 8am to get to work, and then pick up a ride again after work at 5pm. Furthermore, this pattern is not observed on *Weekends*.

```{r}
bikes %>% 
  mutate(hour = hour(started_at)) %>% 
  group_by(member_casual, hour) %>% 
  count(hour, sort = TRUE) %>% 
  ggplot(aes(hour, n, color = member_casual)) + 
  geom_line() + scale_color_manual(values = c("blue", "green4")) +
  scale_x_continuous(breaks = seq(0,24,4), labels = function(x) paste0(x, ":00")) +
  labs(y = "", x = "", title = "Number of Rides per Hour", color = "")
```

```{r}
bikes %>% 
  filter(day_label %in% c("Sat", "Sun")) %>% 
  mutate(hour = hour(started_at)) %>% 
  group_by(member_casual, hour) %>% 
  count(hour, sort = TRUE) %>% 
  ggplot(aes(hour, n, color = member_casual)) + 
  geom_line() + scale_color_manual(values = c("blue", "green4")) +
  scale_x_continuous(breaks = seq(0,24,4), labels = function(x) paste0(x, ":00")) +
  labs(y = "", x = "", title = "Number of Rides per Hour only Weekends", 
       subtitle = "Saturday and Sunday", color = "") +
  theme(plot.subtitle = element_text(hjust = 0.5))
```

```{r}
wide_fun <- function(data){
  data %>% 
    group_by(member_casual) %>% 
    count(start_station_name) %>% 
    pivot_wider(names_from = member_casual, values_from = n) %>% 
    mutate(casual = ifelse(is.na(casual), 0, casual),
           member = ifelse(is.na(member), 0, member),
           pct_casual = casual/sum(casual),
           pct_member = member/sum(member),
           the_largest = ifelse(pct_casual > pct_member, pct_casual, pct_member),
           status = ifelse(pct_casual > pct_member, "casual", "member")) %>% 
    select(start_station_name, the_largest, status)
}
```

```{r}
#s_bikes %>% 
#  inner_join(wide_fun(s_bikes)) %>% 
#  ggplot(aes(start_lng, start_lat, color = status, size = the_largest)) +
#  geom_point(alpha = 0.5) + scale_size(range = c(1,2)) +
#  labs(y = "Latitude", x = "Longitude", title = "Map of Members vs Casuals",
#       subtitle = "Colored by which Group Disportionally Uses that Station")
```

```{r}
wide_fun(bikes) %>% 
  group_by(status) %>% 
  summarize(max = max(the_largest),
            median = median(the_largest),
            mean = mean(the_largest),
            min = min(the_largest))
```

```{r}
wide_fun(bikes) %>% 
  ggplot(aes(the_largest, fill = status)) + geom_density(alpha = 0.4) +
  scale_x_log10() + labs(y = "", x = "",)
```
